---
layout:     post
title:      分布式系统：Split-Brain
subtitle:   
date:       2019-09-05
author:     danner
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - 大数据
    - 分布式
    - hadoop
    - zookeeper
    - 脑裂
---

`Split-Brain` 中文名**脑裂**，顾名思义脑子里有两个想法，不知道做什么决定是正确的。

在介绍脑裂之前，先来说下**假死**。在**分布式系统**中，大多数都是 `Master-Slave` 模式，为了保证高可用都有监控器通过**心跳**监控当前 `master` 状态。监控器发现 `master` **挂掉**后会立刻启动备用 `master` 保证系统的高可用。监控器是根据**心跳超时**来判断 `master`挂掉，但若是 `master` 和监控器之间**网络问题**也可能导致超时。这种情况下 `master` 并未死掉，称为**假死**。但此时监控器已经通知备用 `master` 称为 `active master`，原本 `master` 心跳又正常了，此时系统中会存在两个 `master`。当 `slave` 面对两个 `active master` 时，你说该怎么办呢？


### zookeeper

`zookeeper` 集群是主从模式当然也是会遇到脑裂的情况：`master` 切换时，`client` 也获得 `master` 切换的消息，但是仍然会有一些延时，`zookeeper` 需要通讯需要**一个一个通知**。此时**老的 master** 活过来了，这时候整个系统就很混乱可能有一部分 `client` 已经通知到了连接到**新的 master** 上去了，有的 `client`仍然连接在**老的 master** 上如果同时有两个 `client` 需要对 `master` 的**同一个数据更新**并且刚好这两个 `client` 此刻**分别**连接在新老的 `master` 上，就会出现很严重问题。

`Zookeeper` 解决 `split-Brain` 的方法有三种：

- `Quorums`（ˈkwôrəm 法定人数） ：比如3个节点的集群，Quorums = 2, 也就是说集群可以容忍1个节点失效，这时候还能选举出1个lead，集群还可用。比如4个节点的集群，它的Quorums = 3，Quorums要超过3，相当于集群的容忍度还是1，如果2个节点失效，那么整个集群还是无效的(`live_node >= total_node/2+1`)

- `Redundant communications`：冗余通信的方式，集群中采用多种通信方式，防止一种通信方式失效导致集群中的节点无法通信(`心跳 HA`)

- `Fencing`, 共享资源的方式：比如能看到共享资源就表示在集群中，能够获得共享资源的锁的就是 `Leader`，看不到共享资源的，就不在集群中。

`ZooKeeper` **默认**采用了 `Quorums` 这种方式，即只有集群中超过**半数节点**投票才能选举出 `Leader`：假设某个 `leader` 假死，其余的 `followers` 选举出了一个**新的 leader**。这时，**旧的 leader** 复活并且仍然认为自己是 `leader`，这个时候它向其他 `followers` 发出写请求也是会被**拒绝**的。因为每当**新 leader** 产生时，会生成一个 `epoch`，这个 **epoch是递增**，`followers` 如果确认了**新的 leader** 存在，知道其 `epoch`，就会拒绝 **epoch小于现任 leader epoch** 的所有请求。那有没有 `follower`不知道**新的 leader** 存在呢，有可能，**但肯定不是大多数，否则新 leader无法产生**。`Zookeeper` 的写也遵循 `quorum` 机制，因此，得不到大多数支持的写是无效的，**旧 leader** 即使各种认为自己是 `leader`，依然没有什么作用。

这样的方式可以确保 `leader` 的**唯一性**：

> 要么选出唯一的一个 `leader`,要么选举失败。


### Hadoop






## 参考资料：
[keepalived实现服务高可用](https://www.cnblogs.com/clsn/p/8052649.html)
[Zookeeper已经分布式环境中的假死脑裂](https://blog.csdn.net/u010185262/article/details/49910301)
[面试题：Zookeeper是如何解决脑裂问题](https://blog.csdn.net/u013374645/article/details/93140148)