---
layout:     post
title:      CDH 离线部署笔记
subtitle:   
date:       2019-10-07
author:     danner
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - CDH
    - 部署
    - bigdata
---

`CDH` 部署方式有三种：

- `bin` 在线部署，需要访问外网
- `rpm` 离线部署，但要下载相应的**依赖包**，不是真正的离线部署(还是需要访问外网或私服)
- `tar`离线部署，真正的 `CDH` 离线部署方式

`CDH`离线不是分为三部分：`MySQL`、`CM`、`Parcel` 文件；其中 `MySQL` 存储**元数据**，`CM` (cloudera-manager) 是大数据集群安装部署利器， `Parcel` 文件包含的大数据组件 (`yarn`、`hdfs`、`zk`、`hive` ... ) 二进制包。

### 准备

本节是在阿里云上进行部署

#### 阿里云

三台机子( 2核 8G)，操作系统 `CentOS 7.2`

#### `hosts`

编辑 `/etc/hosts` 文件，注意 `ip` 写内网(只要不释放内网 ip 不变)

``` shell
172.16.204.18 hadoop001
172.16.204.20 hadoop002
172.16.204.19 hadoop003
```

#### 防火墙

本次操作是在**云主机**上，默认都是关闭的需要在 `web` 界面配置：实例 -> 更多 ->网络和安全组 -> 安全组配置->配置规则，在此界面配置出/入方向端口策略。

若在内网服务器，可在部署时先关闭防火墙，等部署后之后，再通过 `CDHweb` 界面将防火墙开启。操作命令如下

```shell
systemctl stop firewalld
systemctl disable firewalld
iptables -L		// 查询防火墙规则
iptables -F		// 删除防火墙规则
```

#### `SELinux`

**关闭** `SELinux`

```sehll
vi /etc/selinux/config
将 SELINUX=enforcing 改为 SELINUX=disabled
```

**重启**生效

#### 时区和时钟同步

- 时区

  - 执行 `date` 查看当前时间并知道时间格式

    ```shell
    [root@hadoop002 ~]# date
    Wed Oct  9 17:17:26 CST 2019
    // CST 中部标准时间 才是我们需要的，否则要修改
    ```

  - `timedatectl` 命令可查看和设置时区

    ```shell
    [root@hadoop002 ~]# timedatectl
          Local time: Wed 2019-10-09 17:14:14 CST	// 本地时间
      Universal time: Wed 2019-10-09 09:14:14 UTC
            RTC time: Wed 2019-10-09 17:14:13
           Time zone: Asia/Shanghai (CST, +0800)   // 时区
         NTP enabled: yes
    NTP synchronized: yes
     RTC in local TZ: yes
          DST active: n/a
    // 设置时区
    [root@hadoop002 ~]# timedatectl set-timezone Asia/Shanghai
    ```

- 时钟同步

  `ntp` 实现机器之间的时间同步

  ```she
  yum install -y ntp
  ```

  本次操作将 `hadoop001` 当作主节点，`hadoop002 -- 003` 当作从节点：主节点从网络拉取时间，从节点从主节点拉取时间

  - 主节点

    ```shell
    [root@hadoop001 ~]# vi /etc/ntp.conf 
    driftfile  /var/lib/ntp/drift
    pidfile    /var/run/ntpd.pid
    logfile    /var/log/ntp.log
    
    # 添加以下内容
    # time 网络获取
    server 0.asia.pool.ntp.org
    server 1.asia.pool.ntp.org
    server 2.asia.pool.ntp.org
    server 3.asia.pool.ntp.org
    # 当外部时间不可⽤时，可使⽤本地硬件时间
    server 127.127.1.0 iburst local clock
    # 允许哪些⽹段的机器来同步时间(当前阿里云的内网网段)
    restrict 172.16.204.0 mask 255.255.255.0 nomodify notrap
    ...
    ```

    ```shell
    [root@hadoop001 ~]# systemctl start ntpd
    [root@hadoop001 ~]# systemctl status ntpd
    ntpd.service - Network Time Service
       Loaded: loaded (/usr/lib/systemd/system/ntpd.service; enabled; vendor preset: disabled)
       Active: active (`running`) since Wed 2019-10-09 17:32:19 CST; 2h 37min ago
     Main PID: 18685 (ntpd)
       CGroup: /system.slice/ntpd.service
               鈹斺攢18685 /usr/sbin/ntpd -u ntp:ntp -g
    
    Oct 09 17:32:19 hadoop001 systemd[1]: Starting Network Time Service...
    Oct 09 17:32:19 hadoop001 ntpd[18685]: proto: precision = 0.089 usec
    Oct 09 17:32:19 hadoop001 ntpd[18685]: 0.0.0.0 c01d 0d kern kernel time sync enabled
    Oct 09 17:32:19 hadoop001 systemd[1]: Started Network Time Service.
    [root@hadoop001 ~]# ntpq -p			// 验证
         remote           refid      st t when poll reach   delay   offset  jitter
    ==============================================================================
     `LOCAL(0)        .LOCL.          10 l 158m   64    0    0.000    0.000   0.000`
    -120.25.115.20   10.137.53.7      2 u  349  512  377   28.395   -8.285   0.960
    ...      
    ```

  - 从节点

    ```shell
    // 禁用 ntpd 服务
    [root@hadoop002 ~]# systemctl stop ntpd
    [root@hadoop002 ~]# systemctl disable ntpd
    Removed symlink /etc/systemd/system/multi-user.target.wants/ntpd.service.
    ```

    ```shell
    // 从 hadoop001 同步时间
    [root@hadoop002 ~]# /usr/sbin/ntpdate hadoop001
     9 Oct 20:33:40 ntpdate[18832]: adjust time server 172.16.204.18 offset 0.003356 sec
    ```

    ```shell
    // 每次都要手动执行同步时间太繁琐，在 crontab 定时
    [root@hadoop003 ~]# crontab -e
    # 每小时同步时间
    00 * * * * /usr/sbin/ntpdate hadoop001	
    ```

#### `JDK`

> `jdk` 必须安装在 `/usr/java` 目录

```shell
[root@hadoop003 ~]# mkdir /usr/java
[root@hadoop003 ~]# tar -zxvf cdh5.16/jdk-8u45-linux-x64.gz -C /usr/java/
// 用户和用户组的修正
[root@hadoop003 ~]# chown -R root:root /usr/java/jdk1.8.0_45
// 配置 Java 环境变量
[root@hadoop001 ~]# vi /etc/profile
# env
export JAVA_HOME=/usr/java/jdk1.8.0_45
export PATH=$JAVA_HOME/bin:$PATH
[root@hadoop001 ~]# source /etc/profile
[root@hadoop001 ~]# which java
/usr/java/jdk1.8.0_45/bin/java
```

### `MySQL`





## 参考资料

[【若泽大数据】CDH5.16.1企业集群真正离线部署(全网最细，配套视频和文档安装包，生产可实践)](https://www.bilibili.com/video/av52167219/)

[Cloudera Manager(简称CM)+CDH构建大数据平台](https://www.jianshu.com/p/1ed522c1ad1e)

