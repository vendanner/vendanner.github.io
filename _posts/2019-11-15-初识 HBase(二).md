---
layout:     post
title:      初识 HBase(二)
subtitle:   
date:       2019-11-15
author:     danner
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - HBase
    - bigdata
---

在[上一节]( https://vendanner.github.io/2019/11/08/初识-HBase/ ) 大致了解 `HBase` 框架，本节补充知识点。

![](https://vendanner.github.io/img/HBase/HBase-arch.png)

- `HLog`：Write Ahead Log，预写日志(节点上所有region 的写操作)
- `memstore`：先写 HLog，再写memStore
  - 超过**阈值**会 flush 成一个 `storeFile`(flush 影响性能)
  - 当 `storeFile`文件数量增加到一定阈值，会触发 **compaction 合并**(会发生GC)
- `storeFile`：小的file **合并**成大文件，文件大小超过阈值又会**分裂**
- `blockCache`：**读缓存**，`RegionServer` 上所有 region 共享；系统启动时完成初始化工作



### 写流程

![](https://vendanner.github.io/img/HBase/write_step.png)

> 写流程不经过 HMaster

- Clinet 向zk `/hbase/meta-region-server`，获取 **hbase:meta 表所在的 RS 节点**
- 向meta RS 获取 `hbase:meta`，并根据 `rowkey` 找到对应的 RS 节点和 Region
- 写请求发送到对应 RS ，依次写入 HLog 以及对应的 memstore
- memstore 超过阈值，会异步 flush 成 storeFile

### 读流程

![](https://vendanner.github.io/img/HBase/read_step.png)

- Clinet 向zk `/hbase/meta-region-server`，获取 hbase:meta 表所在的 RS 节点
- 向meta RS 获取 `hbase:meta`，并根据 `rowkey` 找到对应的 RS 节点和 Region，缓存在本地
- 将读请求发送到对应的RS 节点进行处理
- 先在 `memstore` 读取数据，找不到则去 `blockcache` 读取，再查不到去 `HFile`。

读取的优先级 memstore <--- blockcache <--- HFile，如果到HDFS 上读取显然是慢了，为了提高读取速度，可以**适当加大** blockcache 容量(基于此有些人会认为 HBase 重写轻读，这显然是不合适的)。为了提高读取速度想使用 blockcache ，先确认在表列簇属性 `BLOCKCACHE` 是否开启，默认为 true。

上面的步骤只是读取到对应 `rowkey` 数据，其实在这之后是还有一步需要处理的。当数据有多版本下需要筛选出最新数据；数据有 delete 时需要去除。写数据时只管写，而读数据可能要跨region 获取且结果还要处理，显然对于 HBase 是**重写轻读**。

### 限制

总所周知，memstore 超过阈值会 flush 成 storefile，sorefile 可能会历经合并、分割，region 也可能被分割。这些都是需要参数去设置，也是生产上的**调优点**。

#### `memstore`









## 参考资料

[若泽数据@J哥Blog](https://hackeruncle.github.io/)



